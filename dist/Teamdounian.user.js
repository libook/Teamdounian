// ==UserScript==
// @name         teamdounian
// @namespace    https://github.com/libook
// @version      2.0.0
// @description  Tools for teambition
// @author       libook7@gmail.com
// @match        https://www.teambition.com/project/*/tasks/scrum/*
// @grant        none
// ==/UserScript==
// 为了便于维护和提升运行效率，执行脚本进行了合并和压缩，完整源代码在GitHub上
!function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";n.r(t);class o{constructor(){this.element=document.createElement("span"),this.element.id="toolb-entrance",this.element.className="logo",this.element.textContent="¯\\_(ツ)_/¯逗年TB工具箱",this.element.addEventListener("click",e=>{e.stopPropagation()});Object.assign(this.element.style,{fontWeight:900});let e=document.querySelector('div[class^="release-ribbon"]');e.parentElement.replaceChild(this.element,e);try{document.querySelector('div[class^="trigger"]').remove()}catch(e){}return this.element}}class r{constructor(e){const t=document.getElementById("toolb-menu");t&&t.remove(),this.element=document.createElement("div"),this.element.id="toolb-menu",this.element.className="toolb";const n=e.getBoundingClientRect(),o={zIndex:1e3,position:"fixed",color:"gray",backgroundColor:"white",top:n.bottom+"px",left:n.left+"px",display:"none",boxShadow:"0 2px 12px 0 rgba(0,0,0,.12)",borderRadius:"4px"};return Object.assign(this.element.style,o),e.addEventListener("mouseover",()=>{this.element.style.display="block"}),this.element.addEventListener("mouseleave",()=>{this.element.style.display="none"}),window.addEventListener("resize",()=>{const t=e.getBoundingClientRect();this.element.style.top=t.bottom+"px",this.element.style.left=t.left+"px"}),document.body.appendChild(this.element),this.element}}class a{constructor(e){this.element=document.createElement("a");return this.element.addEventListener("mouseover",()=>{this.element.style.backgroundColor="#eee"}),this.element.addEventListener("mouseleave",()=>{this.element.style.backgroundColor="white"}),Object.assign(this.element.style,{color:"gray",backgroundColor:"white",lineHeight:"14px",fontSize:"14px",fontFamily:"Helvetica Neue,PingFang SC,Microsoft Yahei,微软雅黑,STXihei,华文细黑,sans-serif",left:"50%",margin:"8px 8px 0 8px",padding:"8px 8px 8px 8px",textAlign:"center",borderRadius:"4px"}),e.appendChild(this.element),this.element}}class s{constructor(e){const t=new a(e);t.text="导出6个月已完成",t.addEventListener("click",async()=>{let e=[],t="";const n=new Date,o=new Date(new Date(n).setMonth(n.getMonth()-6));for(;;){const n=await this.request(t);if(t=n.nextPageToken,e=e.concat(n.result),n.result.findIndex(e=>new Date(e.accomplished)<o)>=0)break}console.log(e)})}async request(e){return await fetch(`https://www.teambition.com/api/tasks/me:execute?isDone=true&orderBy=accomplished&pageToken=${e}&pageSize=30`,{credentials:"include",headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10.15; rv:70.0) Gecko/20100101 Firefox/70.0",Accept:"text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8","Accept-Language":"zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2","Upgrade-Insecure-Requests":"1",Pragma:"no-cache","Cache-Control":"no-cache"},method:"GET",mode:"cors"}).then((function(e){return e.json()}))}}function i(){let e,t;const n=window.location.href.split("/");for(let o=0;o<n.length;o++)switch(n[o]){case"project":e=n[o+1];break;case"scrum":t=n[o+1]}return{projectId:e,scrumId:t,taskId:void 0}}class l{constructor(e){const t=function(t,n){const o=new a(e);o.text=t,o.addEventListener("click",()=>{const e=document.querySelector(n);e.scrollIntoView({behavior:"smooth",block:"center",inline:"start"}),e.style.backgroundColor="#3da8f5",window.setTimeout((function(){e.style.backgroundColor=""}),3e3)})};fetch(`https://www.teambition.com/api/stages?_tasklistId=${i().scrumId}&_=${Date.now()}`).then(e=>e.json()).then(e=>{console.log(e);for(let n in e){const o=e[n];o.name.indexOf("※")>=0&&t(o.name.replace(/※/,""),`div.kanban-single-lane-body-wrapper>div:nth-child(0n+${Number(n)+1})`)}})}}function c(){return document.querySelector('div[class^="user-info-trigger"]>span').attributes.style.value}let d;class u{constructor(){d&&window.clearInterval(d);d=window.setInterval((function(){const e=document.querySelectorAll(`\n                            html >\n                            body >\n                            div#teambition-web-content.clearfix >\n                            div.project-app-view >\n                            div.board-view >\n                            div.board-flex-view >\n                            div.board-right-view >\n                            div.kanban-view >\n                            div.kanban-contents-wrapper >\n                            div.kanban-root >\n                            div.kanban-scroll-container.kanban-single-lane-scroll >\n                            div.kanban-single-lane-body >\n                            div.kanban-single-lane-body-wrapper >\n                            div.kanban-single-list >\n                            div.kanban-single-list-contents >\n                            div.kanban-bucket >\n                            div.kanban-droppable-bucket.kanban-droppable-bucket-single-list >\n                            div.kanban-droppable-bucket-cards >\n                            div.kanban-dnd-card >\n                            div.task-card >\n                            div.task-card-body >\n                            div.task-content-set >\n                            header.task-content-wrapper >\n                            span.flex-static.hinted[style='${c()}']\n                            `);for(let t of e)t.parentElement.parentElement.parentElement.parentElement.style.backgroundColor="#3da8f5"}),2e3)}}class p{constructor(e){const t=new a(e);t.text="设置开始时间为现在",t.addEventListener("click",()=>{const{taskId:e}=i();e?fetch("https://www.teambition.com/api/tasks/"+e,{method:"PUT",body:JSON.stringify({startDate:(new Date).toISOString()}),headers:new Headers({"Content-Type":"application/json"})}).then(e=>e.json()).catch(e=>console.error("Error:",e)).then(e=>console.log("Success:",e)):alert("请先打开一个任务。")})}}class m{constructor(e){const t=document.createElement("ul");Object.assign(t.style,{display:"flex",flexDirection:"column",paddingBottom:"8px"}),e.appendChild(t),new l(t),new p(t),new u,new s(t)}}let b={};setInterval(()=>{const e=i();document.querySelector('div[class^="release-ribbon"]')&&document.querySelector(".kanban-dnd-card")&&(b.projectId!==e.projectId||b.scrumId!==e.scrumId)&&(b=e,function(){const e=new o,t=new r(e);new m(t)}())},1e3)}]);